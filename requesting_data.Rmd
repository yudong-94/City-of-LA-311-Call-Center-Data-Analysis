---
title: "requesting_data"
author: "Yu Dong"
date: "11/29/2016"
output: html_document
---

# Load dataset

Load useful packages and the downloaded dataset from https://data.lacity.org/A-Well-Run-City/MyLA311-Service-Request-Data-2016/ndkd-k878

```{r load}
setwd("~/Desktop/DSO545/Final project")
# load("processed1.RData")
library(dplyr)
library(ggplot2)
library(lubridate)
library(stringr)
library(ggmap)
library(zipcode)
library(choroplethrZip) #https://github.com/arilamstein/choroplethrZip
request_data = read.csv("raw data/MyLA311_Service_Request_Data_2016.csv")
```

# Preprocessing

Preprocess the data:  
change the format of time variables using lubridate package  

```{r preprocess}
request_data$CreatedDate = mdy_hms(request_data$CreatedDate)
request_data$UpdatedDate = mdy_hms(request_data$UpdatedDate)
# since there are lots of observations like xx/xx/xxxx 12:00:00AM which leads to unaccurate time records, remove the hour-minute_seconds part
request_data$ServiceDate = str_replace_all(request_data$ServiceDate, " [0-9]{2}:[0-9]{2}:[0-9]{2} [AP]M", "")
request_data$ServiceDate = mdy(request_data$ServiceDate)
# attention: there are many obviously unreasonable records: many records with service date of 1900/01/01, and some other service dates in 2017 or later
request_data$ClosedDate = mdy_hms(request_data$ClosedDate)
```

Calculate new variables:  
1. extract the month, weekday and hour the request created  
2. create the response period in hours as the time from created date to closed date

```{r new variables}
# extract the month, weekday and hour of CreatedDate
request_data$month_created = month(request_data$CreatedDate)
request_data$weekday_created = wday(request_data$CreatedDate, label = TRUE)
request_data$hour_created = hour(request_data$CreatedDate)

# calculate response period (ClosedDate - CreatedDate)
request_data$response_period = round((request_data$ClosedDate - request_data$CreatedDate) / (60 * 60),2)  # round to 2 digits, in hours

# special attention: the percentage of requests without a ClosedDate: 0.546
nrow(filter(request_data, is.na(ClosedDate)))/ nrow(request_data)
```

# Trial run for sampled data

Sampling 1000 observations from the whole dataset.

```{r sampling}
# load("processed_requests.RData")
set.seed(1)
sampled_data = sample_n(request_data, 1000)
```

## Geographical analysis

Plot the contour plot for all the calls, we can find that there are two centers.

```{r map}
LA_map = qmap("Los Angeles", zoom = 10, maptype = "road")
LA_map + 
    stat_density2d(data = sampled_data,
                   aes(x = Longitude, y = Latitude, fill = ..level..),
                   geom = "polygon", alpha = 0.3) +
    scale_fill_gradient(low = "white", high = "darkred")
```

Analysis on zipcode

```{r map2}
sampled_zip = merge(sampled_data, zipcode, by.x = "ZipCode", by.y = "zip")
LA_map +   
    geom_point(data = sampled_data,
               aes(x = Longitude, y = Latitude),
               size = 5, alpha = 0.1, color = "darkred")

requests_zip = sampled_data %>% 
    group_by(ZipCode) %>%
    filter(!ZipCode %in% c("0", "")) %>%
    summarise(value = n())
colnames(requests_zip) = c("region", "value") 
zip_vec = unique(requests_zip$region)

# plot all zips in LA
zip_choropleth(requests_zip,
               county_zoom=6037, 
               title="Requests number by zipcode",
               legend="Requests numbers")

# plot only the zips appear in the data
zip_choropleth(requests_zip, 
               zip_zoom = zip_vec, 
               title="Requests number by zipcode",
               legend="Requests numbers")

```

Plot for the whole dataset

```{r all data}
request_data$ZipCode = str_replace_all(request_data$ZipCode, "[a-zA-Z ,]*", "")
requests_zip = request_data %>% 
    group_by(ZipCode) %>%
    filter(!ZipCode %in% c("0", "", "9008")) %>%
    summarise(value = n())
colnames(requests_zip) = c("region", "value") 


zip_vec = unique(requests_zip$region)

# plot all zips in LA
zip_choropleth(requests_zip,
               county_zoom=6037, 
               title="Requests numbers by zipcode",
               legend="Requests numbers")

# plot only the zips appear in the data
zip_choropleth(requests_zip, 
               zip_zoom = zip_vec, 
               title="Requests numbers by zipcode",
               legend="Requests numbers")
```

Contrast with population by zipcode

```{r pop zip}
population_zip = read.csv("zip_population_2010_census.csv")
population_zip = select(population_zip, Zip.Code, Total.Population)
colnames(population_zip) = c("region", "value")
population_zip$region = as.character(population_zip$region)
zip_vec2 = unique(population_zip$region)
zip_choropleth(population_zip, 
               zip_zoom = zip_vec, 
               title="Population by zipcode",
               legend="Population")
```

Summary statistics

```{r stat}
requests_zip %>%
    mutate(requests_prop = round(value / sum(value), 3)) %>%
    arrange(-requests_prop) %>%
    top_n(10)
population_zip %>%
    filter(region %in% zip_vec) %>%
    mutate(pop_prop = round(value / sum(value), 3)) %>%
    arrange(-pop_prop) %>%
    top_n(10)
```

The requests are more concentrated in certain areas, and there are some differences between the lists of most frequent zipcodes

## Analysis on request sources and types

## Analysis by time